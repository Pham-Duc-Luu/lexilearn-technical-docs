---
title: Quy TrÃ¬nh XÃ¡c Thá»±c NgÆ°á»i DÃ¹ng vá»›i JWT ğŸš€
sidebar_position: 2
---

TÃ i liá»‡u nÃ y mÃ´ táº£ quy trÃ¬nh xÃ¡c thá»±c ngÆ°á»i dÃ¹ng sá»­ dá»¥ng **JSON Web Tokens (JWT)** trong kiáº¿n trÃºc microservices. Quy trÃ¬nh bao gá»“m Ä‘Äƒng kÃ½/Ä‘Äƒng nháº­p, táº¡o token, kiá»ƒm soÃ¡t truy cáº­p vÃ  cÆ¡ cháº¿ lÃ m má»›i token. ğŸ‰

## Tá»•ng Quan ğŸŒŸ

Há»‡ thá»‘ng xÃ¡c thá»±c sá»­ dá»¥ng JWT vá»›i thuáº­t toÃ¡n **RSA256** Ä‘á»ƒ báº£o máº­t truy cáº­p ngÆ°á»i dÃ¹ng. CÃ³ hai loáº¡i token chÃ­nh:

- **Access Token**: Token ngáº¯n háº¡n, Ä‘Æ°á»£c gá»­i trong header `Authorization` Ä‘á»ƒ truy cáº­p tÃ i nguyÃªn báº£o vá»‡. ğŸ”‘
- **Refresh Token**: Token dÃ i háº¡n, lÆ°u trong cookie HttpOnly, dÃ¹ng Ä‘á»ƒ táº¡o láº¡i access token khi háº¿t háº¡n. ğŸ”„

Há»‡ thá»‘ng sá»­ dá»¥ng cáº·p khÃ³a cÃ´ng khai - bÃ­ máº­t (`private-key.pem` vÃ  `public-key.pem`) Ä‘á»ƒ kÃ½ vÃ  xÃ¡c minh token. KhÃ³a cÃ´ng khai Ä‘Æ°á»£c phÃ¢n phá»‘i Ä‘áº¿n cÃ¡c microservices Ä‘á»ƒ xÃ¡c minh access token, Ä‘áº£m báº£o truy cáº­p mÆ°á»£t mÃ . ğŸ›¡ï¸

## Quy TrÃ¬nh XÃ¡c Thá»±c ğŸ“‹

```mermaid
sequenceDiagram
    participant Client
    participant AuthServer as Authentication Server
    participant ResourceServer as Resource Server
    participant Database

    %% ÄÄƒng kÃ½/ÄÄƒng nháº­p
    Client->>AuthServer: POST /api/v1/auth/register or /login (email, password)
    AuthServer->>Database: Validate credentials
    Database-->>AuthServer: Valid user
    AuthServer->>AuthServer: Generate access_token (RSA256, private-key.pem)
    AuthServer->>AuthServer: Generate refresh_token (RSA256, private-key.pem)
    AuthServer->>Database: Store refresh_token
    AuthServer-->>Client: { "access_token": "<JWT>" } + Set-Cookie: refresh_token (HttpOnly, Secure)

    %% Truy cáº­p tÃ i nguyÃªn báº£o vá»‡
    Client->>ResourceServer: GET /api/v1/desks (Authorization: Bearer <access_token>)
    ResourceServer->>ResourceServer: AccessTokenFilter: Verify token (public-key.pem)
    alt Token valid
        ResourceServer->>Database: Fetch user data (e.g., desks)
        Database-->>ResourceServer: User data
        ResourceServer-->>Client: User data (JSON)
    else Token invalid/missing
        ResourceServer-->>Client: 401 Unauthorized
    end

    %% LÃ m má»›i token
    Client->>AuthServer: POST /api/v1/auth/refresh (Cookie: refresh_token)
    AuthServer->>Database: Verify refresh_token
    alt Refresh token valid
        AuthServer->>AuthServer: Generate new access_token
        AuthServer->>AuthServer: (Optional) Generate new refresh_token
        AuthServer->>Database: Update refresh_token
        AuthServer-->>Client: { "access_token": "<NEW_JWT>" } + (Optional) New refresh_token cookie
    else Refresh token invalid
        AuthServer-->>Client: 401 Unauthorized
    end
```

### 1. ÄÄƒng KÃ½ hoáº·c ÄÄƒng Nháº­p ğŸ‘¤

- **API**: `/api/v1/auth/register` hoáº·c `/api/v1/auth/login`
- **Quy trÃ¬nh**:
  - Client gá»­i yÃªu cáº§u POST vá»›i thÃ´ng tin Ä‘Äƒng nháº­p (email, máº­t kháº©u). ğŸ“§
  - Server xÃ¡c thá»±c thÃ´ng tin.
  - Náº¿u thÃ nh cÃ´ng, server táº¡o:
    - **Access Token** báº±ng `AccessTokenJwtService`. ğŸ”
    - **Refresh Token** báº±ng `RefreshTokenJwtService`. ğŸ”„
  - **Pháº£n há»“i**:
    - JSON chá»©a access token:
      ```json
      {
        "access_token": "<JWT_ACCESS_TOKEN>"
      }
      ```
    - Refresh token Ä‘Æ°á»£c Ä‘áº·t trong cookie HttpOnly vá»›i cÃ¡c thuá»™c tÃ­nh:
      - **TÃªn**: `refresh_token`
      - **HttpOnly**: `true` (ngÄƒn truy cáº­p tá»« JavaScript) ğŸš«
      - **Secure**: `true` (chá»‰ gá»­i qua HTTPS) ğŸ”’
      - **SameSite**: `Strict` (chá»‘ng CSRF) ğŸ›‘
      - **Path**: `/` (kháº£ dá»¥ng toÃ n domain) ğŸŒ
      - **Max-Age**: Thá»i háº¡n tÃ¹y chá»‰nh (VD: 24 giá») â³
    - VÃ­ dá»¥ mÃ£ táº¡o cookie (Java - Spring):
      ```java
      ResponseCookie cookie = ResponseCookie.from("refresh_token", refreshToken)
          .httpOnly(true)
          .secure(true)
          .sameSite("Strict")
          .path("/")
          .maxAge(Duration.ofHours(refreshTokenDuration))
          .build();
      response.addHeader(HttpHeaders.SET_COOKIE, cookie.toString());
      ```

### 2. Táº¡o Token ğŸ”¨

- **Thuáº­t toÃ¡n**: RSA256 (cÃ³ thá»ƒ tÃ¹y chá»‰nh sang RSA384 hoáº·c RSA512). âš™ï¸
- **KhÃ³a**:
  - **KhÃ³a bÃ­ máº­t** (`private-key.pem`): DÃ¹ng Ä‘á»ƒ kÃ½ access vÃ  refresh token. ğŸ”‘
  - **KhÃ³a cÃ´ng khai** (`public-key.pem`): DÃ¹ng Ä‘á»ƒ xÃ¡c minh token, Ä‘Æ°á»£c chia sáº» cho microservices. ğŸ“¤
- **Payload cá»§a Access Token**:
  - Chá»©a thÃ´ng tin ngÆ°á»i dÃ¹ng dáº¡ng JSON vÃ  cÃ¡c claim riÃªng:
    ```json
    {
      "user": "{\"user_email\":\"phamducluu2003@gmail.com\",\"user_name\":\"Pham Duc Luu\",\"user_id\":\"10\",\"user_uuid\":\"7d1b9692-ee75-11ef-bda1-0242ac110002\"}",
      "user_email": "phamducluu2003@gmail.com",
      "user_name": "phamducluu2003@gmail.com"
    }
    ```
  - CÃ³ thá»i háº¡n (VD: 1 giá»). â°
- **Refresh Token**:
  - Cáº¥u trÃºc payload tÆ°Æ¡ng tá»±, nhÆ°ng thá»i háº¡n dÃ i hÆ¡n (VD: 24 giá»). ğŸ•°ï¸
  - LÆ°u an toÃ n trÃªn server Ä‘á»ƒ xÃ¡c minh khi lÃ m má»›i token. ğŸ’¾
- **MÃ£ vÃ­ dá»¥** (Táº¡o Access Token):
  ```java
  public String genToken(UserJWTObject userJWTObject) throws HttpResponseException {
      return JWT.create()
          .withClaim(JwtClaims.User.getClaimName(), userJWTObject.toJson())
          .withClaim(JwtClaims.USER_EMAIL.getClaimName(), userJWTObject.getUser_email())
          .withClaim(JwtClaims.USER_NAME.getClaimName(), userJWTObject.getUser_email())
          .withIssuedAt(Instant.now())
          .withExpiresAt(Instant.now().plus(Duration.ofHours(Long.parseLong(tokenDurationInHour))))
          .sign(algorithm);
  }
  ```

### 3. Truy Cáº­p TÃ i NguyÃªn Báº£o Vá»‡ ğŸ—„ï¸

- **API**: CÃ¡c tÃ i nguyÃªn báº£o vá»‡ (VD: `/api/v1/desks`, `/api/v1/images`).
- **YÃªu cáº§u**:
  - Client pháº£i Ä‘Ã­nh kÃ¨m access token trong header `Authorization`:
    ```
    Authorization: Bearer <JWT_ACCESS_TOKEN>
    ```
- **Bá»™ lá»c (Filter)**:
  - CÃ¡c yÃªu cáº§u tá»›i API báº£o vá»‡ (VD: `/api/v1/*`) Ä‘i qua `AccessTokenFilter`. ğŸš¨
  - Bá»™ lá»c:
    - TrÃ­ch xuáº¥t token tá»« header `Authorization`. ğŸ”
    - XÃ¡c minh token báº±ng khÃ³a cÃ´ng khai qua `AccessTokenJwtService.verify()`. âœ…
    - Kiá»ƒm tra tÃ­nh há»£p lá»‡ (VD: chÆ°a háº¿t háº¡n, chá»¯ kÃ½ há»£p lá»‡). âœ”ï¸
    - Náº¿u há»£p lá»‡, trÃ­ch xuáº¥t claim (VD: `user_email`, `user_name`) vÃ  Ä‘áº·t vÃ o thuá»™c tÃ­nh yÃªu cáº§u. ğŸ“‹
    - Náº¿u khÃ´ng há»£p lá»‡ hoáº·c thiáº¿u token, tráº£ vá» lá»—i 401 Unauthorized:
      ```json
      {
        "status": 401,
        "error": "Unauthorized",
        "message": "Missing access token",
        "path": "<REQUEST_URI>"
      }
      ```
  - CÃ¡c API miá»…n kiá»ƒm tra (VD: `/api/v1/auth/*`, `/api/v1/graphql/*`) khÃ´ng qua bá»™ lá»c. ğŸšª
- **MÃ£ vÃ­ dá»¥** (Logic Bá»™ lá»c):

  ```java
  public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
      HttpServletRequest httpRequest = (HttpServletRequest) request;
      String token = httpHeaderUtil.extractTokenFromHeader(httpRequest);
      boolean isProtected = protectedUrlPatterns.stream()
          .anyMatch(pattern -> pattern.matcher(httpRequest.getRequestURI()).matches());
      boolean isExclude = excludedUrlPatterns.stream()
          .anyMatch(pattern -> pattern.matcher(httpRequest.getRequestURI()).matches());

      if (isProtected && !isExclude) {
          if (token == null) {
              HttpErrorDto errorResponse = new HttpErrorDto(
                  HttpStatus.UNAUTHORIZED.value(),
                  HttpStatus.UNAUTHORIZED.getReasonPhrase(),
                  "Missing access token",
                  httpRequest.getRequestURI()
              );
              httpResponse.setStatus(HttpStatus.UNAUTHORIZED.value());
              response.setContentType("application/json");
              try (PrintWriter writer = response.getWriter()) {
                  writer.write(httpHeaderUtil.errorResponseToJson(errorResponse));
              }
              return;
          }
          try {
              DecodedJWT decodedJWT = accessTokenJwtService.verify(token);
              Claim email_claim = decodedJWT.getClaim(JwtClaims.USER_EMAIL.getClaimName());
              httpRequest.setAttribute("email", email_claim.asString());
          } catch (JWTVerificationException e) {
              HttpErrorDto errorResponse = new HttpErrorDto(
                  HttpStatus.UNAUTHORIZED.value(),
                  HttpStatus.UNAUTHORIZED.getReasonPhrase(),
                  e.getMessage(),
                  httpRequest.getRequestURI()
              );
              httpResponse.setStatus(HttpStatus.UNAUTHORIZED.value());
              response.setContentType("application/json");
              try (PrintWriter writer = response.getWriter()) {
                  writer.write(httpHeaderUtil.errorResponseToJson(errorResponse));
              }
              return;
          }
      }
      chain.doFilter(request, response);
  }
  ```

### 4. LÃ m Má»›i Token ğŸ”„

- **API**: `/api/v1/auth/refresh`
- **Quy trÃ¬nh**:
  - Khi access token háº¿t háº¡n, client gá»­i yÃªu cáº§u vá»›i refresh token (lÆ°u trong cookie HttpOnly). ğŸ“¬
  - Server:
    - XÃ¡c minh refresh token báº±ng `RefreshTokenJwtService.verify()` so vá»›i token lÆ°u trÃªn server. ğŸ”
    - Náº¿u há»£p lá»‡, táº¡o access token má»›i báº±ng `AccessTokenJwtService.genToken()`. ğŸ†•
    - Tráº£ vá» access token má»›i:
      ```json
      {
        "access_token": "<NEW_JWT_ACCESS_TOKEN>"
      }
      ```
    - CÃ³ thá»ƒ táº¡o refresh token má»›i vÃ  cáº­p nháº­t cookie. ğŸ”„
  - Náº¿u refresh token khÃ´ng há»£p lá»‡ hoáº·c háº¿t háº¡n, client pháº£i Ä‘Äƒng nháº­p láº¡i. ğŸšª
- **Báº£o máº­t**:
  - Refresh token Ä‘Æ°á»£c lÆ°u an toÃ n trÃªn server Ä‘á»ƒ ngÄƒn truy cáº­p trÃ¡i phÃ©p. ğŸ”
  - Thuá»™c tÃ­nh HttpOnly vÃ  Secure cá»§a cookie báº£o vá»‡ refresh token khá»i script phÃ­a client vÃ  chá»‰ truyá»n qua HTTPS. ğŸ›¡ï¸

## TÃ­ch Há»£p Microservices ğŸŒ

- **PhÃ¢n phá»‘i khÃ³a cÃ´ng khai**:
  - `public-key.pem` Ä‘Æ°á»£c chia sáº» cho táº¥t cáº£ microservices Ä‘á»ƒ xÃ¡c minh access token. ğŸ“¤
  - Má»—i microservice dÃ¹ng khÃ³a cÃ´ng khai Ä‘á»ƒ giáº£i mÃ£ access token vÃ  láº¥y payload (VD: `user_email`, `user_id`) Ä‘á»ƒ phÃ¢n quyá»n. ğŸ”
- **Sá»­ dá»¥ng Payload**:
  - Claim `user` chá»©a chuá»—i JSON vá»›i thÃ´ng tin chi tiáº¿t:
    ```json
    {
      "user_email": "phamducluu2003@gmail.com",
      "user_name": "Pham Duc Luu",
      "user_id": "10",
      "user_uuid": "7d1b9692-ee75-11ef-bda1-0242ac110002"
    }
    ```
  - Microservices phÃ¢n tÃ­ch payload Ä‘á»ƒ phÃ¢n quyá»n vÃ  cÃ¡ nhÃ¢n hÃ³a yÃªu cáº§u. ğŸ¯

## CÃ¡c Yáº¿u Tá»‘ Báº£o Máº­t ğŸ”’

- **Cookie HttpOnly vÃ  Secure**: NgÄƒn táº¥n cÃ´ng XSS vÃ  Ä‘áº£m báº£o truyá»n táº£i an toÃ n. ğŸ›¡ï¸
- \*\*SameSite=Strict /

\*\*: Chá»‘ng táº¥n cÃ´ng CSRF. ğŸš«

- **Access Token ngáº¯n háº¡n**: Giáº£m rá»§i ro náº¿u token bá»‹ rÃ² rá»‰. â³
- **LÆ°u trá»¯ Refresh Token**: LÆ°u an toÃ n trÃªn server ngÄƒn tÃ¡i táº¡o token trÃ¡i phÃ©p. ğŸ’¾
- **Thuáº­t toÃ¡n RSA256**: Cung cáº¥p báº£o máº­t mÃ£ hÃ³a máº¡nh máº½. ğŸ”
- **Loáº¡i trá»« bá»™ lá»c**: Äáº£m báº£o cÃ¡c API cÃ´ng khai (nhÆ° API xÃ¡c thá»±c) luÃ´n truy cáº­p Ä‘Æ°á»£c mÃ  khÃ´ng cáº§n token. ğŸšª

## Káº¿t Luáº­n ğŸ‰

Quy trÃ¬nh xÃ¡c thá»±c dá»±a trÃªn JWT nÃ y cung cáº¥p giáº£i phÃ¡p báº£o máº­t vÃ  má»Ÿ rá»™ng cho viá»‡c xÃ¡c thá»±c ngÆ°á»i dÃ¹ng trong mÃ´i trÆ°á»ng microservices. Vá»›i RSA256, cookie HttpOnly vÃ  cÆ¡ cháº¿ bá»™ lá»c máº¡nh máº½, há»‡ thá»‘ng Ä‘áº£m báº£o truy cáº­p an toÃ n vÃ o tÃ i nguyÃªn báº£o vá»‡ Ä‘á»“ng thá»i duy trÃ¬ kháº£ nÄƒng lÃ m má»›i token mÆ°á»£t mÃ . ğŸŒŸ
